{"codeModel":{"additionalSerialNumber":0,"codeFormatOrNot":0,"codeOrdinal":2,"defaultFilenameSetting":0,"fileName":"delay.c","fileType":1,"formatContent":"[{\"text\":\"#include \\\"delay.h\\\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#include \\\"sys.h\\\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#include \\\"usart.h\\\" \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"////////////////////////////////////////////////////////////////////////////////// \\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//如果使用OS,则包括下面的头文件（以ucos为例）即可.\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#if SYSTEM_SUPPORT_OS\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#include \\\"includes.h\\\"\\t\\t\\t\\t\\t//支持OS时，使用\\t  \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#endif\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//////////////////////////////////////////////////////////////////////////////////  \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//本程序只供学习使用，未经作者许可，不得用于其它任何用途\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//ALIENTEK STM32F407开发板\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//使用SysTick的普通计数模式对延迟进行管理(支持OS)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//包括delay_us,delay_ms\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//正点原子@ALIENTEK\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//技术论坛:www.openedv.com\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//创建日期:2014/5/2\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//版本：V1.3\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//版权所有，盗版必究。\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//Copyright(C) 广州市星翼电子科技有限公司 2014-2024\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//All rights reserved\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//********************************************************************************\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//修改说明\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//V1.1 20140803 \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//1,delay_us,添加参数等于0判断,如果参数等于0,则直接退出. \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//2,修改ucosii下,delay_ms函数,加入OSLockNesting的判断,在进入中断后,也可以准确延时.\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//V1.2 20150411  \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//修改OS支持方式,以支持任意OS(不限于UCOSII和UCOSIII,理论上任意OS都可以支持)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//添加:delay_osrunning/delay_ostickspersec/delay_osintnesting三个宏定义\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//添加:delay_osschedlock/delay_osschedunlock/delay_ostimedly三个函数\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//V1.3 20150521\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//修正UCOSIII支持时的2个bug：\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//delay_tickspersec改为：delay_ostickspersec\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//delay_intnesting改为：delay_osintnesting\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"////////////////////////////////////////////////////////////////////////////////// \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"static u8  fac_us=0;\\t\\t\\t\\t\\t\\t\\t//us延时倍乘数\\t\\t\\t   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"static u16 fac_ms=0;\\t\\t\\t\\t\\t\\t\\t//ms延时倍乘数,在os下,代表每个节拍的ms数\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"u8 delay_mode = 1;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"u8 gui_time = 0;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#if SYSTEM_SUPPORT_OS\\t\\t\\t\\t\\t\\t\\t//如果SYSTEM_SUPPORT_OS定义了,说明要支持OS了(不限于UCOS).\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//当delay_us/delay_ms需要支持OS的时候需要三个与OS相关的宏定义和函数来支持\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//首先是3个宏定义:\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//    delay_osrunning:用于表示OS当前是否正在运行,以决定是否可以使用相关函数\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//delay_ostickspersec:用于表示OS设定的时钟节拍,delay_init将根据这个参数来初始哈systick\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"// delay_osintnesting:用于表示OS中断嵌套级别,因为中断里面不可以调度,delay_ms使用该参数来决定如何运行\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//然后是3个函数:\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//  delay_osschedlock:用于锁定OS任务调度,禁止调度\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//delay_osschedunlock:用于解锁OS任务调度,重新开启调度\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//    delay_ostimedly:用于OS延时,可以引起任务调度.\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//本例程仅作UCOSII和UCOSIII的支持,其他OS,请自行参考着移植\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//支持UCOSII\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#ifdef \\tOS_CRITICAL_METHOD\\t\\t\\t\\t\\t\\t//OS_CRITICAL_METHOD定义了,说明要支持UCOSII\\t\\t\\t\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#define delay_osrunning\\t\\tOSRunning\\t\\t\\t//OS是否运行标记,0,不运行;1,在运行\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#define delay_ostickspersec\\tOS_TICKS_PER_SEC\\t//OS时钟节拍,即每秒调度次数\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#define delay_osintnesting \\tOSIntNesting\\t\\t//中断嵌套级别,即中断嵌套次数\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#endif\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//支持UCOSIII\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#ifdef \\tCPU_CFG_CRITICAL_METHOD\\t\\t\\t\\t\\t//CPU_CFG_CRITICAL_METHOD定义了,说明要支持UCOSIII\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#define delay_osrunning\\t\\tOSRunning\\t\\t\\t//OS是否运行标记,0,不运行;1,在运行\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#define delay_ostickspersec\\tOSCfg_TickRate_Hz\\t//OS时钟节拍,即每秒调度次数\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#define delay_osintnesting \\tOSIntNestingCtr\\t\\t//中断嵌套级别,即中断嵌套次数\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#endif\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//us级延时时,关闭任务调度(防止打断us级延迟)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"void delay_osschedlock(void)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#ifdef CPU_CFG_CRITICAL_METHOD   \\t\\t\\t//使用UCOSIII\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tOS_ERR err; \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tOSSchedLock(&err);\\t\\t\\t\\t\\t\\t//UCOSIII的方式,禁止调度，防止打断us延时\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#else\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t//否则UCOSII\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tOSSchedLock();\\t\\t\\t\\t\\t\\t\\t//UCOSII的方式,禁止调度，防止打断us延时\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#endif\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//us级延时时,恢复任务调度\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"void delay_osschedunlock(void)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"{\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#ifdef CPU_CFG_CRITICAL_METHOD   \\t\\t\\t//使用UCOSIII\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tOS_ERR err; \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tOSSchedUnlock(&err);\\t\\t\\t\\t\\t//UCOSIII的方式,恢复调度\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#else\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t//否则UCOSII\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tOSSchedUnlock();\\t\\t\\t\\t\\t\\t//UCOSII的方式,恢复调度\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#endif\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//调用OS自带的延时函数延时\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//ticks:延时的节拍数\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"void delay_ostimedly(u32 ticks)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#ifdef CPU_CFG_CRITICAL_METHOD\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tOS_ERR err; \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tOSTimeDly(ticks,OS_OPT_TIME_PERIODIC,&err);//UCOSIII延时采用周期模式\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#else\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tOSTimeDly(ticks);\\t\\t\\t\\t\\t\\t//UCOSII延时\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#endif \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\" \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//systick中断服务函数,使用OS时用到\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"void SysTick_Handler(void)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"{\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\tgui_time++;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\tprintf(\\\"\\\\r\\\\n添加\\\\r\\\\n\\\");//串口打印识别结果 \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\tif(SysTick->LOAD==99)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\t{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\t\\tgui_time=0;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\t\\tprintf(\\\"\\\\r\\\\n清零\\\\r\\\\n\\\");//串口打印识别结果 \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\t}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tif(delay_osrunning==1)\\t\\t\\t\\t\\t//OS开始跑了,才执行正常的调度处理\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tOSIntEnter();\\t\\t\\t\\t\\t\\t//进入中断\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tOSTimeTick();       \\t\\t\\t\\t//调用ucos的时钟服务程序               \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tOSIntExit();       \\t \\t\\t\\t\\t//触发任务切换软中断\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#endif\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\t   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//初始化延迟函数\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//当使用OS的时候,此函数会初始化OS的时钟节拍\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//SYSTICK的时钟固定为AHB时钟的1/8\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//SYSCLK:系统时钟频率\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"void delay_init(u8 SYSCLK)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#if SYSTEM_SUPPORT_OS \\t\\t\\t\\t\\t\\t//如果需要支持OS.\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tu32 reload;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#endif\\r\\n\",\"type\":\"StringElement\"},{\"text\":\" \\tSysTick->CTRL&=~(1<<2);\\t\\t\\t\\t\\t//SYSTICK使用外部时钟源\\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tfac_us=SYSCLK/8;\\t\\t\\t\\t\\t\\t//不论是否使用OS,fac_us都需要使用\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#if SYSTEM_SUPPORT_OS \\t\\t\\t\\t\\t\\t//如果需要支持OS.\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\treload=SYSCLK/8;\\t\\t\\t\\t\\t\\t//每秒钟的计数次数 单位为M\\t   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\treload*=1000000/delay_ostickspersec;\\t//根据delay_ostickspersec设定溢出时间\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t//reload为24位寄存器,最大值:16777216,在168M下,约合0.7989s左右\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tfac_ms=1000/delay_ostickspersec;\\t\\t//代表OS可以延时的最少单位\\t   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tSysTick->CTRL|=1<<1;   \\t\\t\\t\\t\\t//开启SYSTICK中断\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tSysTick->LOAD=reload; \\t\\t\\t\\t\\t//每1/delay_ostickspersec秒中断一次\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tSysTick->CTRL|=1<<0;   \\t\\t\\t\\t\\t//开启SYSTICK    \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#else\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tfac_ms=(u16)fac_us*1000;\\t\\t\\t\\t//非OS下,代表每个ms需要的systick时钟数   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t//开启中断，给GUI做定时器\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\tSysTick->CTRL|=1<<1;   \\t\\t\\t\\t\\t//开启SYSTICK中断\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\tSysTick->LOAD=100; \\t\\t\\t\\t\\t//每1/delay_ostickspersec秒中断一次\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\tSysTick->CTRL|=1<<0;   \\t\\t\\t\\t\\t//开启SYSTICK    \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#endif\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//扫码\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\tSysTick->CTRL|=SysTick_CTRL_TICKINT_Msk;   \\t//开启SYSTICK中断\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\tSysTick->LOAD=reload; \\t\\t\\t\\t\\t//每1/delay_ostickspersec秒中断一次\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\tSysTick->CTRL|=SysTick_CTRL_ENABLE_Msk; \\t//开启SYSTICK    \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//#else\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//\\tfac_ms=(u16)fac_us*1000;\\t\\t\\t\\t//非OS下,代表每个ms需要的systick时钟数   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//#endif\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"}\\t\\t\\t\\t\\t\\t\\t\\t    \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#if SYSTEM_SUPPORT_OS \\t\\t\\t\\t\\t\\t//如果需要支持OS.\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//延时nus\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//nus:要延时的us数.\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//nus:0~204522252(最大值即2^32/fac_us@fac_us=21)\\t    \\t\\t\\t\\t\\t\\t\\t\\t   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"void delay_us(u32 nus)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"{\\t\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tu32 ticks;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tu32 told,tnow,tcnt=0;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tu32 reload=SysTick->LOAD;\\t\\t\\t\\t//LOAD的值\\t    \\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tticks=nus*fac_us; \\t\\t\\t\\t\\t\\t//需要的节拍数 \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tdelay_osschedlock();\\t\\t\\t\\t\\t//阻止OS调度，防止打断us延时\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\ttold=SysTick->VAL;        \\t\\t\\t\\t//刚进入时的计数器值\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\twhile(1)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\ttnow=SysTick->VAL;\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tif(tnow!=told)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t{\\t    \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\tif(tnow<told)tcnt+=told-tnow;\\t//这里注意一下SYSTICK是一个递减的计数器就可以了.\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\telse tcnt+=reload-tnow+told;\\t    \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\ttold=tnow;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\tif(tcnt>=ticks)break;\\t\\t\\t//时间超过/等于要延迟的时间,则退出.\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t}  \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t};\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tdelay_osschedunlock();\\t\\t\\t\\t\\t//恢复OS调度\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t    \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"}  \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//延时nms\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//nms:要延时的ms数\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//nms:0~65535\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"void delay_ms(u16 nms)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"{\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tif(delay_osrunning&&delay_osintnesting==0)//如果OS已经在跑了,并且不是在中断里面(中断里面不能任务调度)\\t    \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t{\\t\\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tif(nms>=fac_ms)\\t\\t\\t\\t\\t\\t//延时的时间大于OS的最少时间周期 \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t{ \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"   \\t\\t\\tdelay_ostimedly(nms/fac_ms);\\t//OS延时\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tnms%=fac_ms;\\t\\t\\t\\t\\t\\t//OS已经无法提供这么小的延时了,采用普通方式延时    \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tdelay_us((u32)(nms*1000));\\t\\t\\t\\t//普通方式延时\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#else  //不用ucos时\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//延时nus\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//nus为要延时的us数.\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//注意:nus的值,不要大于798915us(最大值即2^24/fac_us@fac_us=21)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"void delay_us(u32 nus)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"{\\t\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tif(delay_mode)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t//开窗\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tu32 temp;\\t    \\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->LOAD=nus*fac_us; \\t\\t\\t\\t//时间加载\\t  \\t\\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->VAL=0x00;        \\t\\t\\t\\t//清空计数器\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->CTRL=0x01 ;      \\t\\t\\t\\t//开始倒数 \\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tdo\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\ttemp=SysTick->CTRL;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t}while((temp&0x01)&&!(temp&(1<<16)));\\t//等待时间到达   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->CTRL=0x00;      \\t \\t\\t\\t//关闭计数器\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->VAL =0X00;       \\t\\t\\t\\t//清空计数器 \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t}else{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t//扫码\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tu32 temp;\\t    \\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->LOAD=nus*fac_us; \\t\\t\\t\\t//时间加载\\t  \\t\\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->VAL=0x00;        \\t\\t\\t\\t//清空计数器\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->CTRL|=SysTick_CTRL_ENABLE_Msk ; //开始倒数 \\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tdo\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\ttemp=SysTick->CTRL;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t}while((temp&0x01)&&!(temp&(1<<16)));\\t//等待时间到达   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->CTRL&=~SysTick_CTRL_ENABLE_Msk; //关闭计数器\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->VAL =0X00;       \\t\\t\\t\\t//清空计数器 \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//延时nms\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//注意nms的范围\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//SysTick->LOAD为24位寄存器,所以,最大延时为:\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//nms<=0xffffff*8*1000/SYSCLK\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//SYSCLK单位为Hz,nms单位为ms\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//对168M条件下,nms<=798ms \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"void delay_xms(u16 nms)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"{\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tif(delay_mode)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t//开窗\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tu32 temp;\\t\\t   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->LOAD=(u32)nms*fac_ms;\\t\\t\\t//时间加载(SysTick->LOAD为24bit)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->VAL =0x00;           \\t\\t\\t//清空计数器\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->CTRL=0x01 ;          \\t\\t\\t//开始倒数  \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tdo\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\ttemp=SysTick->CTRL;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t}while((temp&0x01)&&!(temp&(1<<16)));\\t//等待时间到达   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->CTRL=0x00;       \\t\\t\\t\\t//关闭计数器\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->VAL =0X00;     \\t\\t  \\t\\t//清空计数器\\t  \\t  \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t}else{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t//扫码\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tu32 temp;\\t\\t   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->LOAD=(u32)nms*fac_ms;\\t\\t\\t//时间加载(SysTick->LOAD为24bit)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->VAL =0x00;           \\t\\t\\t//清空计数器\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->CTRL|=SysTick_CTRL_ENABLE_Msk ;          //开始倒数 \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tdo\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\ttemp=SysTick->CTRL;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t}while((temp&0x01)&&!(temp&(1<<16)));\\t//等待时间到达   \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->CTRL&=~SysTick_CTRL_ENABLE_Msk;       //关闭计数器\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tSysTick->VAL =0X00;     \\t\\t  \\t\\t//清空计数器\\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t} \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"} \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//延时nms \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"//nms:0~65535\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"void delay_ms(u16 nms)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"{\\t \\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tu8 repeat=nms/540;\\t\\t\\t\\t\\t\\t//这里用540,是考虑到某些客户可能超频使用,\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t\\t//比如超频到248M的时候,delay_xms最大只能延时541ms左右了\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tu16 remain=nms%540;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\twhile(repeat)\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t{\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\tdelay_xms(540);\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\trepeat--;\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t}\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\tif(remain)delay_xms(remain);\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"} \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"#endif\\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\t\\t\\t \\r\\n\",\"type\":\"StringElement\"},{\"text\":\"\\r\\n\",\"type\":\"StringElement\"}]","formatType":2,"id":"d4cc1da590244c73a256c9f1d43e3829","moduleId":"7491fc7065774a7e97310e0c221bedf8","path":"SYSTEM\\delay"},"formatStatement":{"codeStatementBeanList":[{"beanValue":"#include \"delay.h\"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#include \"sys.h\"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#include \"usart.h\" \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"////////////////////////////////////////////////////////////////////////////////// \t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//如果使用OS,则包括下面的头文件（以ucos为例）即可.\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#if SYSTEM_SUPPORT_OS\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#include \"includes.h\"\t\t\t\t\t//支持OS时，使用\t  \r\n","gfs":1,"type":"StringElement"},{"beanValue":"#endif\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//////////////////////////////////////////////////////////////////////////////////  \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//本程序只供学习使用，未经作者许可，不得用于其它任何用途\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//ALIENTEK STM32F407开发板\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//使用SysTick的普通计数模式对延迟进行管理(支持OS)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//包括delay_us,delay_ms\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//正点原子@ALIENTEK\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//技术论坛:www.openedv.com\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//创建日期:2014/5/2\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//版本：V1.3\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//版权所有，盗版必究。\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//Copyright(C) 广州市星翼电子科技有限公司 2014-2024\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//All rights reserved\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//********************************************************************************\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//修改说明\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//V1.1 20140803 \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//1,delay_us,添加参数等于0判断,如果参数等于0,则直接退出. \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//2,修改ucosii下,delay_ms函数,加入OSLockNesting的判断,在进入中断后,也可以准确延时.\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//V1.2 20150411  \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//修改OS支持方式,以支持任意OS(不限于UCOSII和UCOSIII,理论上任意OS都可以支持)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//添加:delay_osrunning/delay_ostickspersec/delay_osintnesting三个宏定义\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//添加:delay_osschedlock/delay_osschedunlock/delay_ostimedly三个函数\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//V1.3 20150521\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//修正UCOSIII支持时的2个bug：\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//delay_tickspersec改为：delay_ostickspersec\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//delay_intnesting改为：delay_osintnesting\r\n","gfs":1,"type":"StringElement"},{"beanValue":"////////////////////////////////////////////////////////////////////////////////// \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"static u8  fac_us=0;\t\t\t\t\t\t\t//us延时倍乘数\t\t\t   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"static u16 fac_ms=0;\t\t\t\t\t\t\t//ms延时倍乘数,在os下,代表每个节拍的ms数\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\r\n","gfs":1,"type":"StringElement"},{"beanValue":"u8 delay_mode = 1;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"u8 gui_time = 0;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#if SYSTEM_SUPPORT_OS\t\t\t\t\t\t\t//如果SYSTEM_SUPPORT_OS定义了,说明要支持OS了(不限于UCOS).\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//当delay_us/delay_ms需要支持OS的时候需要三个与OS相关的宏定义和函数来支持\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//首先是3个宏定义:\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//    delay_osrunning:用于表示OS当前是否正在运行,以决定是否可以使用相关函数\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//delay_ostickspersec:用于表示OS设定的时钟节拍,delay_init将根据这个参数来初始哈systick\r\n","gfs":1,"type":"StringElement"},{"beanValue":"// delay_osintnesting:用于表示OS中断嵌套级别,因为中断里面不可以调度,delay_ms使用该参数来决定如何运行\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//然后是3个函数:\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//  delay_osschedlock:用于锁定OS任务调度,禁止调度\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//delay_osschedunlock:用于解锁OS任务调度,重新开启调度\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//    delay_ostimedly:用于OS延时,可以引起任务调度.\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//本例程仅作UCOSII和UCOSIII的支持,其他OS,请自行参考着移植\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//支持UCOSII\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#ifdef \tOS_CRITICAL_METHOD\t\t\t\t\t\t//OS_CRITICAL_METHOD定义了,说明要支持UCOSII\t\t\t\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#define delay_osrunning\t\tOSRunning\t\t\t//OS是否运行标记,0,不运行;1,在运行\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#define delay_ostickspersec\tOS_TICKS_PER_SEC\t//OS时钟节拍,即每秒调度次数\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#define delay_osintnesting \tOSIntNesting\t\t//中断嵌套级别,即中断嵌套次数\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#endif\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//支持UCOSIII\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#ifdef \tCPU_CFG_CRITICAL_METHOD\t\t\t\t\t//CPU_CFG_CRITICAL_METHOD定义了,说明要支持UCOSIII\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#define delay_osrunning\t\tOSRunning\t\t\t//OS是否运行标记,0,不运行;1,在运行\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#define delay_ostickspersec\tOSCfg_TickRate_Hz\t//OS时钟节拍,即每秒调度次数\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#define delay_osintnesting \tOSIntNestingCtr\t\t//中断嵌套级别,即中断嵌套次数\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#endif\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//us级延时时,关闭任务调度(防止打断us级延迟)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"void delay_osschedlock(void)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#ifdef CPU_CFG_CRITICAL_METHOD   \t\t\t//使用UCOSIII\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tOS_ERR err; \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tOSSchedLock(&err);\t\t\t\t\t\t//UCOSIII的方式,禁止调度，防止打断us延时\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#else\t\t\t\t\t\t\t\t\t\t//否则UCOSII\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tOSSchedLock();\t\t\t\t\t\t\t//UCOSII的方式,禁止调度，防止打断us延时\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#endif\r\n","gfs":1,"type":"StringElement"},{"beanValue":"}\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//us级延时时,恢复任务调度\r\n","gfs":1,"type":"StringElement"},{"beanValue":"void delay_osschedunlock(void)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"{\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#ifdef CPU_CFG_CRITICAL_METHOD   \t\t\t//使用UCOSIII\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tOS_ERR err; \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tOSSchedUnlock(&err);\t\t\t\t\t//UCOSIII的方式,恢复调度\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#else\t\t\t\t\t\t\t\t\t\t//否则UCOSII\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tOSSchedUnlock();\t\t\t\t\t\t//UCOSII的方式,恢复调度\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#endif\r\n","gfs":1,"type":"StringElement"},{"beanValue":"}\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//调用OS自带的延时函数延时\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//ticks:延时的节拍数\r\n","gfs":1,"type":"StringElement"},{"beanValue":"void delay_ostimedly(u32 ticks)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#ifdef CPU_CFG_CRITICAL_METHOD\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tOS_ERR err; \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tOSTimeDly(ticks,OS_OPT_TIME_PERIODIC,&err);//UCOSIII延时采用周期模式\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#else\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tOSTimeDly(ticks);\t\t\t\t\t\t//UCOSII延时\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#endif \r\n","gfs":1,"type":"StringElement"},{"beanValue":"}\r\n","gfs":1,"type":"StringElement"},{"beanValue":" \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//systick中断服务函数,使用OS时用到\r\n","gfs":1,"type":"StringElement"},{"beanValue":"void SysTick_Handler(void)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"{\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\tgui_time++;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\tprintf(\"\\r\\n添加\\r\\n\");//串口打印识别结果 \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\tif(SysTick->LOAD==99)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\t{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\t\tgui_time=0;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\t\tprintf(\"\\r\\n清零\\r\\n\");//串口打印识别结果 \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\t}\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tif(delay_osrunning==1)\t\t\t\t\t//OS开始跑了,才执行正常的调度处理\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tOSIntEnter();\t\t\t\t\t\t//进入中断\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tOSTimeTick();       \t\t\t\t//调用ucos的时钟服务程序               \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tOSIntExit();       \t \t\t\t\t//触发任务切换软中断\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t}\r\n","gfs":1,"type":"StringElement"},{"beanValue":"}\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#endif\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\t   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//初始化延迟函数\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//当使用OS的时候,此函数会初始化OS的时钟节拍\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//SYSTICK的时钟固定为AHB时钟的1/8\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//SYSCLK:系统时钟频率\r\n","gfs":1,"type":"StringElement"},{"beanValue":"void delay_init(u8 SYSCLK)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#if SYSTEM_SUPPORT_OS \t\t\t\t\t\t//如果需要支持OS.\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tu32 reload;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#endif\r\n","gfs":1,"type":"StringElement"},{"beanValue":" \tSysTick->CTRL&=~(1<<2);\t\t\t\t\t//SYSTICK使用外部时钟源\t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tfac_us=SYSCLK/8;\t\t\t\t\t\t//不论是否使用OS,fac_us都需要使用\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#if SYSTEM_SUPPORT_OS \t\t\t\t\t\t//如果需要支持OS.\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\treload=SYSCLK/8;\t\t\t\t\t\t//每秒钟的计数次数 单位为M\t   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\treload*=1000000/delay_ostickspersec;\t//根据delay_ostickspersec设定溢出时间\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\t\t\t\t\t\t\t\t\t//reload为24位寄存器,最大值:16777216,在168M下,约合0.7989s左右\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tfac_ms=1000/delay_ostickspersec;\t\t//代表OS可以延时的最少单位\t   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tSysTick->CTRL|=1<<1;   \t\t\t\t\t//开启SYSTICK中断\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tSysTick->LOAD=reload; \t\t\t\t\t//每1/delay_ostickspersec秒中断一次\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tSysTick->CTRL|=1<<0;   \t\t\t\t\t//开启SYSTICK    \r\n","gfs":1,"type":"StringElement"},{"beanValue":"#else\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tfac_ms=(u16)fac_us*1000;\t\t\t\t//非OS下,代表每个ms需要的systick时钟数   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t//开启中断，给GUI做定时器\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\tSysTick->CTRL|=1<<1;   \t\t\t\t\t//开启SYSTICK中断\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\tSysTick->LOAD=100; \t\t\t\t\t//每1/delay_ostickspersec秒中断一次\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\tSysTick->CTRL|=1<<0;   \t\t\t\t\t//开启SYSTICK    \r\n","gfs":1,"type":"StringElement"},{"beanValue":"#endif\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//扫码\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\tSysTick->CTRL|=SysTick_CTRL_TICKINT_Msk;   \t//开启SYSTICK中断\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\tSysTick->LOAD=reload; \t\t\t\t\t//每1/delay_ostickspersec秒中断一次\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\tSysTick->CTRL|=SysTick_CTRL_ENABLE_Msk; \t//开启SYSTICK    \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//#else\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//\tfac_ms=(u16)fac_us*1000;\t\t\t\t//非OS下,代表每个ms需要的systick时钟数   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//#endif\r\n","gfs":1,"type":"StringElement"},{"beanValue":"}\t\t\t\t\t\t\t\t    \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#if SYSTEM_SUPPORT_OS \t\t\t\t\t\t//如果需要支持OS.\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//延时nus\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//nus:要延时的us数.\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//nus:0~204522252(最大值即2^32/fac_us@fac_us=21)\t    \t\t\t\t\t\t\t\t   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"void delay_us(u32 nus)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"{\t\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tu32 ticks;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tu32 told,tnow,tcnt=0;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tu32 reload=SysTick->LOAD;\t\t\t\t//LOAD的值\t    \t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tticks=nus*fac_us; \t\t\t\t\t\t//需要的节拍数 \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tdelay_osschedlock();\t\t\t\t\t//阻止OS调度，防止打断us延时\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\ttold=SysTick->VAL;        \t\t\t\t//刚进入时的计数器值\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\twhile(1)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\ttnow=SysTick->VAL;\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tif(tnow!=told)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t{\t    \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\tif(tnow<told)tcnt+=told-tnow;\t//这里注意一下SYSTICK是一个递减的计数器就可以了.\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\telse tcnt+=reload-tnow+told;\t    \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\ttold=tnow;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\tif(tcnt>=ticks)break;\t\t\t//时间超过/等于要延迟的时间,则退出.\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t}  \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t};\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tdelay_osschedunlock();\t\t\t\t\t//恢复OS调度\t\t\t\t\t\t\t\t\t\t\t    \r\n","gfs":1,"type":"StringElement"},{"beanValue":"}  \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//延时nms\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//nms:要延时的ms数\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//nms:0~65535\r\n","gfs":1,"type":"StringElement"},{"beanValue":"void delay_ms(u16 nms)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"{\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tif(delay_osrunning&&delay_osintnesting==0)//如果OS已经在跑了,并且不是在中断里面(中断里面不能任务调度)\t    \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t{\t\t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tif(nms>=fac_ms)\t\t\t\t\t\t//延时的时间大于OS的最少时间周期 \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t{ \r\n","gfs":1,"type":"StringElement"},{"beanValue":"   \t\t\tdelay_ostimedly(nms/fac_ms);\t//OS延时\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t}\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tnms%=fac_ms;\t\t\t\t\t\t//OS已经无法提供这么小的延时了,采用普通方式延时    \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t}\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tdelay_us((u32)(nms*1000));\t\t\t\t//普通方式延时\r\n","gfs":1,"type":"StringElement"},{"beanValue":"}\r\n","gfs":1,"type":"StringElement"},{"beanValue":"#else  //不用ucos时\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//延时nus\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//nus为要延时的us数.\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//注意:nus的值,不要大于798915us(最大值即2^24/fac_us@fac_us=21)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"void delay_us(u32 nus)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"{\t\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tif(delay_mode)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t//开窗\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tu32 temp;\t    \t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->LOAD=nus*fac_us; \t\t\t\t//时间加载\t  \t\t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->VAL=0x00;        \t\t\t\t//清空计数器\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->CTRL=0x01 ;      \t\t\t\t//开始倒数 \t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tdo\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\ttemp=SysTick->CTRL;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t}while((temp&0x01)&&!(temp&(1<<16)));\t//等待时间到达   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->CTRL=0x00;      \t \t\t\t//关闭计数器\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->VAL =0X00;       \t\t\t\t//清空计数器 \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t}else{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t//扫码\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tu32 temp;\t    \t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->LOAD=nus*fac_us; \t\t\t\t//时间加载\t  \t\t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->VAL=0x00;        \t\t\t\t//清空计数器\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->CTRL|=SysTick_CTRL_ENABLE_Msk ; //开始倒数 \t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tdo\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\ttemp=SysTick->CTRL;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t}while((temp&0x01)&&!(temp&(1<<16)));\t//等待时间到达   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->CTRL&=~SysTick_CTRL_ENABLE_Msk; //关闭计数器\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->VAL =0X00;       \t\t\t\t//清空计数器 \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t}\r\n","gfs":1,"type":"StringElement"},{"beanValue":"}\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//延时nms\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//注意nms的范围\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//SysTick->LOAD为24位寄存器,所以,最大延时为:\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//nms<=0xffffff*8*1000/SYSCLK\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//SYSCLK单位为Hz,nms单位为ms\r\n","gfs":1,"type":"StringElement"},{"beanValue":"//对168M条件下,nms<=798ms \r\n","gfs":1,"type":"StringElement"},{"beanValue":"void delay_xms(u16 nms)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"{\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tif(delay_mode)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t//开窗\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tu32 temp;\t\t   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->LOAD=(u32)nms*fac_ms;\t\t\t//时间加载(SysTick->LOAD为24bit)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->VAL =0x00;           \t\t\t//清空计数器\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->CTRL=0x01 ;          \t\t\t//开始倒数  \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tdo\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\ttemp=SysTick->CTRL;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t}while((temp&0x01)&&!(temp&(1<<16)));\t//等待时间到达   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->CTRL=0x00;       \t\t\t\t//关闭计数器\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->VAL =0X00;     \t\t  \t\t//清空计数器\t  \t  \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t}else{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t//扫码\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tu32 temp;\t\t   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->LOAD=(u32)nms*fac_ms;\t\t\t//时间加载(SysTick->LOAD为24bit)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->VAL =0x00;           \t\t\t//清空计数器\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->CTRL|=SysTick_CTRL_ENABLE_Msk ;          //开始倒数 \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tdo\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\ttemp=SysTick->CTRL;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t}while((temp&0x01)&&!(temp&(1<<16)));\t//等待时间到达   \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->CTRL&=~SysTick_CTRL_ENABLE_Msk;       //关闭计数器\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tSysTick->VAL =0X00;     \t\t  \t\t//清空计数器\t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t} \r\n","gfs":1,"type":"StringElement"},{"beanValue":"} \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//延时nms \r\n","gfs":1,"type":"StringElement"},{"beanValue":"//nms:0~65535\r\n","gfs":1,"type":"StringElement"},{"beanValue":"void delay_ms(u16 nms)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"{\t \t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tu8 repeat=nms/540;\t\t\t\t\t\t//这里用540,是考虑到某些客户可能超频使用,\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\t\t\t\t\t\t\t\t\t//比如超频到248M的时候,delay_xms最大只能延时541ms左右了\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tu16 remain=nms%540;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\twhile(repeat)\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t{\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\tdelay_xms(540);\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\trepeat--;\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t}\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\tif(remain)delay_xms(remain);\r\n","gfs":1,"type":"StringElement"},{"beanValue":"} \r\n","gfs":1,"type":"StringElement"},{"beanValue":"#endif\r\n","gfs":1,"type":"StringElement"},{"beanValue":"\t\t\t \r\n","gfs":1,"type":"StringElement"},{"beanValue":"\r\n","gfs":1,"type":"StringElement"}]}}